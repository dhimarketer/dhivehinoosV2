<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /usr/local/apache2/htdocs
    DirectoryIndex index.html

    # Enable gzip compression with optimal settings
    LoadModule deflate_module modules/mod_deflate.so
    # Compression level (1-9, 6 is good balance) - must be outside <Location>
    DeflateCompressionLevel 6
    <Location />
        SetOutputFilter DEFLATE
        # Don't compress already compressed files
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|webp|avif|ico|svg|woff|woff2|ttf|eot)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar|gz)$ no-gzip dont-vary
        # Compress text-based resources
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css 
        AddOutputFilterByType DEFLATE text/javascript application/javascript 
        AddOutputFilterByType DEFLATE application/json application/xml application/rss+xml
        AddOutputFilterByType DEFLATE application/x-javascript application/xhtml+xml
        AddOutputFilterByType DEFLATE application/x-font-ttf application/x-font-opentype
        AddOutputFilterByType DEFLATE application/vnd.ms-fontobject image/svg+xml
        # Only compress files larger than 1KB
        SetEnvIfNoCase Request_URI \.(?:html|htm|css|js|json|xml)$ no-gzip dont-vary env=no-gzip
        SetEnvIf Request_Content_Length "^(0|[1-9][0-9]{0,2})$" no-gzip
    </Location>

    # Handle React Router - redirect all requests to index.html
    # But exclude certain files that should be proxied to backend
    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable mod_rewrite for React Router
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        # Exclude robots.txt, sitemap.xml - these should be proxied
        RewriteCond %{REQUEST_URI} ^/(robots\.txt|sitemap\.xml)$ [OR]
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule . - [L]
        RewriteRule . /index.html [L]
    </Directory>

    # Don't cache HTML files
    <LocationMatch "^/$|\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </LocationMatch>

    # Ensure correct MIME types for JavaScript modules
    AddType application/javascript .js
    AddType application/javascript .mjs
    AddType text/javascript .js
    
    # Cache static assets with longer expiry
    <LocationMatch "\.(js|mjs|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header unset ETag
        FileETag None
    </LocationMatch>

    # Optimize image serving with appropriate headers
    <LocationMatch "\.(jpg|jpeg|png|gif|webp|avif|svg)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header append Vary "Accept"
    </LocationMatch>

    # Security headers
    LoadModule headers_module modules/mod_headers.so
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>
