version: '3'

services:
  dhivehinoos_backend:
    image: dhimarketer/backend:latest
    container_name: dhivehinoos_backend
    restart: unless-stopped
    ports:
      - "8052:8000"  # Unique port for dhivehinoos backend
    # Load environment variables from .env file in this directory
    env_file:
      - .env
    volumes:
      - /opt/dhivehinoos/database:/app/database
      - /opt/dhivehinoos/media/articles:/app/media/articles
      - /opt/dhivehinoos/media/ads:/app/media/ads
      - /opt/dhivehinoos/static:/app/static
      - /opt/dhivehinoos/logs:/app/logs
    environment:
      # These explicit variables will override any same-named variables from .env
      - DJANGO_SETTINGS_MODULE=dhivehinoos_backend.settings
      - DEBUG=False
      - ALLOWED_HOSTS=dhivehinoos.net,www.dhivehinoos.net,localhost
      - DATABASE_URL=sqlite:////app/database/db.sqlite3
      - SECRET_KEY=${SECRET_KEY}
      - API_INGEST_KEY=${API_INGEST_KEY}
      - USE_MEMORY_CACHE=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/articles/published/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dhivehinoos_frontend:
    image: dhimarketer/frontend:latest
    container_name: dhivehinoos_frontend
    restart: unless-stopped
    ports:
      - "8053:80"  # Unique port for dhivehinoos frontend
    depends_on:
      dhivehinoos_backend:
        condition: service_healthy

# Removed unused 'volumes:' and 'networks:' definitions at the root level
# Using host volumes instead for better control and persistence
