<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /usr/local/apache2/htdocs
    DirectoryIndex index.html

    # Proxy API requests to backend
    ProxyPreserveHost On
    ProxyPass /api/ http://dhivehinoos_backend:8000/api/
    ProxyPassReverse /api/ http://dhivehinoos_backend:8000/api/
    
    # Proxy admin requests to backend
    ProxyPass /admin/ http://dhivehinoos_backend:8000/admin/
    ProxyPassReverse /admin/ http://dhivehinoos_backend:8000/admin/

    # Enable gzip compression
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|webp|avif|ico|svg|woff|woff2|ttf|eot)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml+rss application/rss+xml
    </Location>

    # Handle React Router - redirect all requests to index.html
    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable mod_rewrite for React Router
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Don't cache HTML files
    <LocationMatch "^/$|\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </LocationMatch>

    # Cache static assets with longer expiry
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header unset ETag
        FileETag None
    </LocationMatch>

    # Optimize image serving with appropriate headers
    <LocationMatch "\.(jpg|jpeg|png|gif|webp|avif|svg)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header append Vary "Accept"
    </LocationMatch>

    # Security headers
    LoadModule headers_module modules/mod_headers.so
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>
